name: Publish

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tooling
        run: |
          python -m pip install -U pip
          python -m pip install build twine

      - name: Verify tag matches pyproject version
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          VER_FROM_TAG="${TAG#v}"
          python - <<'PY'
          import sys
          try:
              import tomllib
          except Exception:
              import tomli as tomllib
          from pathlib import Path

          data = tomllib.loads(Path('pyproject.toml').read_text(encoding='utf-8'))
          ver = data['project']['version']
          tag = sys.argv[1]
          if ver != tag:
              raise SystemExit(f"Version mismatch: pyproject.toml has {ver}, tag has {tag}")
          print(f"OK: version {ver} matches tag")
          PY
          "$VER_FROM_TAG"

      - name: Build distributions
        run: |
          python -m build
          python -m twine check dist/*

      - name: Publish to TestPyPI (rc tags)
        if: contains(github.ref_name, '-rc.')
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          python -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*

      - name: Publish to PyPI (stable tags)
        if: ${{ !contains(github.ref_name, '-rc.') }}
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m twine upload dist/*
